<!DOCTYPE html><html lang="en" data-astro-cid-37fxchfa> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="icon" type="image/x-icon" href="/favicon.ico"><title>Node.js Event Loop | Hello, World</title><meta name="description"><meta property="og:image"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"><link rel="stylesheet" href="/_assets/_slug_.5Zos-WDK.css">
<style>.comments[data-astro-cid-on2fnc7p]{margin-top:2rem}.comments-title[data-astro-cid-on2fnc7p]{font-size:1.25rem;font-weight:600;color:#1f2937;margin-bottom:1rem}.giscus-container[data-astro-cid-on2fnc7p]{margin-top:1rem}.blog-post[data-astro-cid-bvzihdzo]{margin-bottom:2rem}.blog-title[data-astro-cid-bvzihdzo]{font-size:2rem;font-weight:700;color:#1f2937;margin-bottom:.5rem}@media (min-width: 768px){.blog-title[data-astro-cid-bvzihdzo]{font-size:2.25rem}}.blog-date[data-astro-cid-bvzihdzo]{display:block;font-size:.875rem;color:#6b7280;margin-bottom:2rem}.blog-content[data-astro-cid-bvzihdzo]{margin-top:1.5rem;line-height:1.7}.blog-content[data-astro-cid-bvzihdzo] h2{font-size:1.5rem;font-weight:600;color:#1f2937;margin:2rem 0 1rem}.blog-content[data-astro-cid-bvzihdzo] h3{font-size:1.25rem;font-weight:600;color:#1f2937;margin:1.5rem 0 1rem}.blog-content[data-astro-cid-bvzihdzo] p{margin-bottom:1.25rem}.blog-content[data-astro-cid-bvzihdzo] img{max-width:100%;height:auto;display:block;margin:2rem auto;border-radius:4px;box-shadow:0 2px 4px #0000001a}.blog-content[data-astro-cid-bvzihdzo] ul,.blog-content[data-astro-cid-bvzihdzo] ol{margin-left:2rem;margin-bottom:1.25rem}.blog-content[data-astro-cid-bvzihdzo] li{margin-bottom:.5rem}.blog-content[data-astro-cid-bvzihdzo] a{color:#0284c7;text-decoration:none}.blog-content[data-astro-cid-bvzihdzo] a:hover{text-decoration:underline}.comments-section[data-astro-cid-bvzihdzo]{margin-top:4rem;padding-top:2rem;border-top:1px solid #e5e7eb}
</style></head> <body style="min-height: 100vh; display: flex; flex-direction: column; background-color: #f9fafb;" data-astro-cid-37fxchfa> <div class="container-main" style="flex-grow: 1;" data-astro-cid-37fxchfa> <header class="header" data-astro-cid-3ef6ksr2> <div class="header-container" data-astro-cid-3ef6ksr2> <div class="brand" data-astro-cid-3ef6ksr2> <a href="/" class="site-title" data-astro-cid-3ef6ksr2>Hello, World</a> <a href="https://webring.wonderful.software#curiousdev.in.th" title="วงแหวนเว็บ" class="webring" data-astro-cid-3ef6ksr2> <img alt="วงแหวนเว็บ" width="32" height="32" src="https://webring.wonderful.software/webring.black.svg" class="webring-image" data-astro-cid-3ef6ksr2> </a> </div> <nav data-astro-cid-3ef6ksr2> <ul class="nav-list" data-astro-cid-3ef6ksr2> <li data-astro-cid-3ef6ksr2> <a href="/" class="nav-item" data-astro-cid-3ef6ksr2>Home</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/blog" class="nav-item" data-astro-cid-3ef6ksr2>Blog</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/about" class="nav-item" data-astro-cid-3ef6ksr2>About</a> </li> <li data-astro-cid-3ef6ksr2> <a href="/contact" class="nav-item" data-astro-cid-3ef6ksr2>Contact</a> </li> </ul> </nav> </div> </header>  <script type="module">const e=document.querySelectorAll("nav a");e.forEach(t=>{(t.getAttribute("href")===window.location.pathname||t.getAttribute("href")==="/blog"&&window.location.pathname.startsWith("/blog/"))&&t.setAttribute("aria-current","page")});</script> <main style="padding-top: 2rem; padding-bottom: 2rem;" data-astro-cid-37fxchfa>  <article class="blog-post" data-astro-cid-bvzihdzo> <h1 class="blog-title" data-astro-cid-bvzihdzo>Node.js Event Loop</h1> <time class="blog-date" data-astro-cid-bvzihdzo>October 10, 2020</time> <div class="blog-content" data-astro-cid-bvzihdzo>  <p>สวัสดีครับ ไม่ได้เขียน blog มานานเป็นเดือนละ เนื่องจากผมค่อนข้างยุ่งกับการเปลี่ยนงานใหม่และงานก็ค่อนข้างถาโถมเข้ามาแบบเยอะเลยทีเดียว (555) แต่ก็ยังพอมีเวลาไปศึกษา <code>node.js</code> เพิ่มเติมอยู่บ้าง โดยเฉพาะการทำงานภายในของตัว <code>node.js</code> เอง ซึ่ง blog นี้ก็จะนำเสนอเกี่ยวกับ <strong>Event Loop</strong> ซึ่งมีบทบาทสำคัญเป็นอย่างมากในตัว <code>node.js</code> core หวังว่าจะเป็นประโยชน์ต่อคนที่กำลังศึกษา <code>node.js</code> อยู่นะครับ code และเนื้อหาหลักๆ ผมจะอ้างอิงจาก <a href="https://www.udemy.com/course/advanced-node-for-developers/">Node JS: Advanced Concepts</a> ของ <a href="https://twitter.com/ste_grider">Stephen Grider</a> ครับผม</p>
<h2 id="prerequisite">Prerequisite</h2>
<ul>
<li>Intermediate Javascript (asynchronous, callbacks)</li>
</ul>
<h2 id="what-is-the-event-loop">What is the Event Loop?</h2>
<p>Node.js คือ runtime environment เพื่อดำเนินการ run Javascript ฝั่ง server side เราทราบกันดีอยู่แล้วว่า Javascript ทำงานบน <strong>Single-Threaded</strong> ดังนั้น Event Loop คือสิ่งที่คอยจัดการ <strong>asynchronous non-blocking I/O operations</strong> ใน node นั่นเอง เปรียบเสมือนเป็นโครงสร้างที่ควบคุมและตัดสินใจว่าจะทำ task ใดในช่วงเวลาหนึ่งบน thread นั้นๆ ซึ่งการทำงานของ Event Loop จะทำงานอยู่บน thread เดียวโดยมีวัฏจักรการทำงานตาม diagram รูปล่าง</p>
<pre class="language-bash" data-language="bash"><code is:raw="" class="language-bash">   ┌───────────────────────────┐
┌─<span class="token operator">></span>│           timers          │
│  └─────────────┬─────────────┘
│  ┌─────────────┴─────────────┐
│  │     pending callbacks     │
│  └─────────────┬─────────────┘
│  ┌─────────────┴─────────────┐
│  │       idle, prepare       │
│  └─────────────┬─────────────┘      ┌───────────────┐
│  ┌─────────────┴─────────────┐      │   incoming:   │
│  │           poll            │<span class="token operator">&#x3C;</span>─────┤  connections, │
│  └─────────────┬─────────────┘      │   data, etc.  │
│  ┌─────────────┴─────────────┐      └───────────────┘
│  │           check           │
│  └─────────────┬─────────────┘
│  ┌─────────────┴─────────────┐
└──┤      close callbacks      │
   └───────────────────────────┘
</code></pre>
<p><em>Ref: <a href="https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/">The Node.js Event Loop, Timers, and <code>process.nextTick()</code></a></em></p>
<p>สมมติว่าเราเขียน code ในไฟล์ <code>index.js</code> แล้วเราจะใช้คำสั่ง run <code>node index.js</code> แต่ละช่วง Event Loop จะมีการทำงานดังต่อไปนี้</p>
<ul>
<li><strong>Timers</strong>: เป็นการจัดการเกี่ยวกับเวลา เช่น <code>setTimeout()</code> หรือ <code>setInterval()</code></li>
<li><strong>Pending callbacks</strong>: เป็นช่วงที่ต้องจัดการเกี่ยวกับ callbacks ต่างๆ</li>
<li><strong>Idle, prepare</strong>: เป็นช่วงเวลาที่ event loop กลับไปอยู่ที่สถานะ “รอ” เพื่อให้ tasks ใดๆ ดำเนินการเสร็จ เดี๋ยวผมจะลงรายละเอียดอีกทีนะครับ</li>
<li><strong>Poll</strong>: จัดการเกี่ยวกับ I/O event ต่างๆ</li>
<li><strong>Check</strong>: <code>setImmediate()</code> callbacks</li>
<li><strong>Close callbacks</strong>: close event ต่างๆ เช่น <code>socket.on('close', ...)</code></li>
</ul>
<p>ทีนี้อาจจะยังมองภาพไม่ออกว่าแต่ละช่วงนั้น Event Loop มันทำงานของมันยังไงกันแน่ ต่อไปผมจะเอาแต่ละช่วงมาเขียนเป็น psuedo code ดูนะครับ เพื่อให้เข้าใจมากขึ้น</p>
<pre class="language-javascript" data-language="javascript"><code is:raw="" class="language-javascript"><span class="token comment">//----- Totally FAKE code -----//</span>

<span class="token comment">// สมมติว่า run node index.js</span>

<span class="token comment">// Tasks ต่างๆ ที่ Event Loop ต้องทำการตรวจสอบ</span>
<span class="token comment">// และตัดสินใจว่าจะดำเนินการอย่างไรต่อไป</span>
<span class="token keyword">const</span> pendingTimers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> pendingOSTasks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> pendingOperations <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// shouldContinue() คือตัวแทนการทำงานของ Event Loop</span>
<span class="token comment">// ซึ่ง function นี้จะคืนค่า truthy หรือ falsy</span>
<span class="token keyword">function</span> <span class="token function">shouldContinue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    pendingTimers<span class="token punctuation">.</span>length <span class="token operator">||</span> pendingOSTasks<span class="token punctuation">.</span>length <span class="token operator">||</span> pendingOperations<span class="token punctuation">.</span>length
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// เข้าสู่ Event Loop</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">shouldContinue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">// exit back to terminal</span>
</code></pre>
<h2 id="event-loops-phases-in-detail">Event Loop’s phases in Detail</h2>
<p>รายละเอียดการทำงานในแต่ละช่วงของ Event Loop มีดังนี้</p>
<ol>
<li><strong>Event Loop</strong> จะตรวจสอบว่ามี task ใน <code>pendingTimers</code> หรือไม่ ซึ่งก็คือ <code>setTimeout()</code> และ <code>setInterval()</code> ถ้ามี ก็จะทำการ execute callbacks function ที่อยู่ใน <code>pendingTimers</code> เหล่านั้น</li>
<li>ต่อไปก็คือการตรวจสอบว่ามี <code>pendingOSTasks</code> และ <code>pendingOperations</code> อยู่หรือไม่ เช่น การเรียก <code>httpServer.listen(PORT)</code> หรือการเรียกใช้ file system module <code>fs</code></li>
<li>จากนั้น Event Loop จะเข้าสู่ <strong>idle, prepare</strong> รอที่จะดำเนินการต่อไปเมื่อ
<ul>
<li>ทำ <code>pendingOSTasks</code> เสร็จ</li>
<li>ทำ <code>pendingOperations</code> เสร็จ</li>
<li>timer ถึงเวลาที่กำหนดและดำเนินการเรียก callback function ในนั้น</li>
</ul>
</li>
<li>ตรวจสอบ <code>pendingTimers</code> อีกครั้งและเรียก <code>setImmediate</code> function</li>
<li>จัดการ <code>close event</code> เช่น <code>socket.on('close', ...)</code> หรือ <code>readStream.on('close', ...)</code></li>
</ol>
<p>ถ้ามี <code>pendingTask</code> ใดใดสักอันหนึ่งที่มี task อยู่ข้างใน (length > 0) <code>shouldContinue()</code> ก็จะคืนค่าเป็น <code>true</code> Event Loop ก็จะดำเนินวัฏจักรของมันไปเรื่อยๆ (<code>while (true) {}</code>) จนกว่าทุก ๆ <code>pendingTask</code> หมดไป <code>shouldContinue()</code> ก็จะคืนค่าเป็น <code>false</code> และออกมาจาก loop นั่นเอง</p>
<h2 id="is-nodejs-single-threaded">Is Node.js single-threaded?</h2>
<p>มาถึงตรงนี้ อยากจะตั้งคำถามกับคุณผู้อ่านสักหน่อยว่า Node.js เป็น single-thread หรือไม่?</p>
<p>คำตอบคือ…</p>
<p><strong><em>ทั้งใช่ และไม่ใช่…</em></strong></p>
<p>เริ่มงงกันแล้วใช่มั้ยครับ 555</p>
<p>ผมจะแบ่งเป็น 2 ประเด็นหลักๆ ละกันนะครับ</p>
<ol>
<li>ถ้าเป็นตัว Event Loop - ใช่ครับ มันทำงานอยู่บน single-threaded</li>
<li>แต่ถ้าเป็น module หรือ standard library บางตัวของ เช่น <code>fs, crypto, zlib</code> - ไม่ใช่ single-threaded ครับ</li>
</ol>
<p>บางคนอาจจะสงสัย ว่าอ้าว javascript เป็น single-threaded นี่ node เองก็ใช้ javascript แล้วทำไมไม่ใช่ single-thread ทั้งหมดล่ะ</p>
<p>ลองมาดูตัวอย่างกันครับ</p>
<pre class="language-javascript" data-language="javascript"><code is:raw="" class="language-javascript"><span class="token comment">// thread.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> pbkdf2 <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> start <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">pbkdf2</span><span class="token punctuation">(</span><span class="token string">'pwd'</span><span class="token punctuation">,</span> <span class="token string">'salt'</span><span class="token punctuation">,</span> <span class="token number">100000</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token string">'sha512'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">1: Done in </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><code>pdkdf2</code> เป็น function ที่ใช้ทำการเข้ารหัส ในตัวอย่างจะใช้ <code>sha512</code> เป็น secure hash algorithm ทีนี้ลอง run <code>node thread.js</code> ดูครับ ก็จะได้ผลลัพธ์ประมาณนี้</p>
<p><img  src="/_assets/first_threaded.Otrj1AHB_ZsPPIM.webp" alt="hash" width="1102" height="404" loading="lazy" decoding="async"></p>
<p>ทีนี้ลองเพิ่มไปอีก 3 ชุดคำสั่ง</p>
<pre class="language-javascript" data-language="javascript"><code is:raw="" class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span> pbkdf2 <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> start <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">pbkdf2</span><span class="token punctuation">(</span><span class="token string">'pwd'</span><span class="token punctuation">,</span> <span class="token string">'salt'</span><span class="token punctuation">,</span> <span class="token number">100000</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token string">'sha512'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">1: Done in </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">pbkdf2</span><span class="token punctuation">(</span><span class="token string">'pwd'</span><span class="token punctuation">,</span> <span class="token string">'salt'</span><span class="token punctuation">,</span> <span class="token number">100000</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token string">'sha512'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">2: Done in </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">pbkdf2</span><span class="token punctuation">(</span><span class="token string">'pwd'</span><span class="token punctuation">,</span> <span class="token string">'salt'</span><span class="token punctuation">,</span> <span class="token number">100000</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token string">'sha512'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">3: Done in </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">pbkdf2</span><span class="token punctuation">(</span><span class="token string">'pwd'</span><span class="token punctuation">,</span> <span class="token string">'salt'</span><span class="token punctuation">,</span> <span class="token number">100000</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token string">'sha512'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">4: Done in </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>แล้ว run ดูอีกครั้งครับจะได้</p>
<p><img  src="/_assets/more_hash.BfoE3Yx-_Z1HG03q.webp" alt="more hash" width="1148" height="740" loading="lazy" decoding="async"></p>
<p>อ้าววววว ทำไมเหมือนกับว่าเกิดขึ้นพร้อมกันเลยล่ะ? ถ้า node เป็น single-threaded จริง มันต้องทำตามลำดับ 1 —> 2 —> 3 —> 4 ใช้มั้ยครับ ดูจากรูปผม run หลายๆ ครั้งให้ดูเลย เพื่อให้เห็นชัดเจนว่ามันเกิดขึ้น ๆ พร้อมๆ กัน</p>
<p>สาเหตุที่เป็นแบบนี้ ก็เพราะว่า standard module บางตัว (เช่น crypto) ที่มีการใช้ cpu ประมวลผลสูง node จะไม่ได้ run แค่ single-threaded แต่จะอาศัยตัวช่วยอย่าง <a href="http://docs.libuv.org/en/v1.x/threadpool.html">uv thread pool</a> โดยที่ค่าเริ่มต้นของ <code>uv_thread_pool</code> ก็คือ 4 ถ้าเราอยากให้มัน run แค่ thread เดียว ก็สามารถทำได้แบบนี้ครับ</p>
<pre class="language-javascript" data-language="javascript"><code is:raw="" class="language-javascript"><span class="token comment">// กำหนด UV_THREADPOOL_SIZE แบบนี้</span>
<span class="token comment">// ใส่ไว้ข้างบนสุดของ code เมื่อกี้</span>
process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">UV_THREADPOOL_SIZE</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre>
<p>แล้วทีนี้ลอง run ดูอีกครั้งครับ ผลที่ได้คือ</p>
<p><img  src="/_assets/single_thread.CIyWu-35_Z1pJ08R.webp" alt="single threaded" width="1072" height="596" loading="lazy" decoding="async"></p>
<p>ถ้าลองไปอ่านที่ <a href="http://docs.libuv.org/en/v1.x/threadpool.html">doc</a> ของ libuv จะพบว่าเราสามารถกำหนด <code>UV_THREADPOOL_SIZE</code> ได้ถึง 1024 ลองไปเล่นๆ กันดูได้ครับ สรุปคือ node จะใช้ Event Loop บน main thread และจะมี threadpool จาก libuv เอาไว้คอยจัดการพวก cpu intensive task</p>
<h2 id="os-operations">OS Operations</h2>
<p>ต่อไปก็มาทำความเข้าใจเกี่ยวกับ <code>os operations</code> หรือ <code>pendingOSTasks</code> ที่ผมเขียนไว้ใน psuedo code ตัวอย่างนะครับ ซึ่งเป็นอีกตัวที่น่าสนใจเช่นกัน ลองดู code ตัวอย่างกันครับ</p>
<pre class="language-javascript" data-language="javascript"><code is:raw="" class="language-javascript"><span class="token comment">// async.js</span>
<span class="token keyword">const</span> https <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'https'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> start <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">doRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  https
    <span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token string">'https://www.google.com'</span><span class="token punctuation">,</span> <span class="token parameter">res</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">doRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>แล้ว run <code>node async.js</code> จะได้เป็น</p>
<p><img  src="/_assets/async_request.CO6Y1jw4_Z1GLpQ3.webp" alt="async request" width="1102" height="590" loading="lazy" decoding="async"></p>
<p>ทีนี้ลองเพิ่มการเรียก function <code>doRequest()</code> ให้เป็นสัก 7 ครั้ง</p>
<pre class="language-javascript" data-language="javascript"><code is:raw="" class="language-javascript"><span class="token function">doRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">doRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">doRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">doRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">doRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">doRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><img  src="/_assets/more_async.CFdQN8of_hrsXJ.webp" alt="more async" width="1100" height="628" loading="lazy" decoding="async"></p>
<p>อ้าวววว เรียกไปตั้ง 6 ครั้ง แต่ก็ run พร้อมๆ กันแหะ! ยังไงเนี่ยยยย</p>
<p>คำตอบก็คือเมื่อมีการทำ network request แบบ code ข้างบน node จะไม่ได้ใช้ <code>UV_THREADPOOL</code> แต่จะไปเรียกใช้ <strong>asynchronous interface</strong> ซึ่งแต่ละระบบปฏิบัติการมีให้อยู่แล้วแทน ถ้าเป็น linux ก็จะเป็น <a href="https://man7.org/linux/man-pages/man7/aio.7.html">AIO</a> เป็นต้น</p>
<p>หวังว่าจะช่วยคลายข้อสงสัยเกี่ยวกับการทำงานของ Event Loop ไม่มากก็น้อยนะครับ ถ้ามีเวลา ผมจะมาเขียนเกี่ยวกับสิ่งที่น่าสนใจของ Node.js อีกเรื่อยๆ นะครับ</p>
<p>Happy Coding :)</p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://www.udemy.com/course/advanced-node-for-developers/">Node JS: Advanced Concepts</a></li>
<li><a href="http://docs.libuv.org/en/v1.x/threadpool.html">Thread pool work scheduling</a></li>
<li><a href="https://www.dynatrace.com/news/blog/all-you-need-to-know-to-really-understand-the-node-js-event-loop-and-its-metrics/#disqus_thread">All you need to know to really understand the Node.js Event Loop and its Metrics</a></li>
<li><a href="https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/">The Node.js Event Loop, Timers, and <code>process.nextTick()</code></a></li>
<li><a href="https://www.youtube.com/watch?v=PNa9OMajw9w">Morning Keynote- Everything You Need to Know About Node.js Event Loop - Bert Belder</a></li>
</ul>  </div> </article> <div class="comments-section" data-astro-cid-bvzihdzo> <section class="comments" data-astro-cid-on2fnc7p> <h2 class="comments-title" data-astro-cid-on2fnc7p>Comments</h2> <div class="giscus-container" data-astro-cid-on2fnc7p> <script src="https://giscus.app/client.js" data-repo="xeusteerapat/xeusteerapat.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkyMTkyNTY4NzY=" data-category="General" data-category-id="DIC_kwDODRGYLM4COf8-" data-mapping="title" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="light" data-lang="en" crossorigin="anonymous" async>
    </script> </div> </section>  </div>  </main> </div> <footer class="footer" data-astro-cid-sz7xmlte> <div class="container-main footer-content" data-astro-cid-sz7xmlte> <div class="social-links" data-astro-cid-sz7xmlte> <a href="https://github.com/xeusteerapat" target="_blank" rel="noopener noreferrer" class="social-link" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>GitHub</span> <svg class="social-icon" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true" data-astro-cid-sz7xmlte> <path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd" data-astro-cid-sz7xmlte></path> </svg> </a> <a href="https://twitter.com/xeusteerapat" target="_blank" rel="noopener noreferrer" class="social-link" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Twitter</span> <svg class="social-icon" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true" data-astro-cid-sz7xmlte> <path d="M8.29 20.251c7.547 0 11.675-6.253 11.675-11.675 0-.178 0-.355-.012-.53A8.348 8.348 0 0022 5.92a8.19 8.19 0 01-2.357.646 4.118 4.118 0 001.804-2.27 8.224 8.224 0 01-2.605.996 4.107 4.107 0 00-6.993 3.743 11.65 11.65 0 01-8.457-4.287 4.106 4.106 0 001.27 5.477A4.072 4.072 0 012.8 9.713v.052a4.105 4.105 0 003.292 4.022 4.095 4.095 0 01-1.853.07 4.108 4.108 0 003.834 2.85A8.233 8.233 0 012 18.407a11.616 11.616 0 006.29 1.84" data-astro-cid-sz7xmlte></path> </svg> </a> <a href="https://www.linkedin.com/in/teerapat-prommarak/" target="_blank" rel="noopener noreferrer" class="social-link" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>LinkedIn</span> <svg class="social-icon" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true" data-astro-cid-sz7xmlte> <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z" data-astro-cid-sz7xmlte></path> </svg> </a> </div> <p class="copyright" data-astro-cid-sz7xmlte>
Created by Teerapat Prommarak, © 2025 </p> </div> </footer>  </body></html> 